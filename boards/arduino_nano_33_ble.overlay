/*
 * AutoWatering â€“ Arduino Nano 33 BLE enhanced storage & peripherals overlay
 * W25Q128 external flash for NVS storage and BLE OTA updates.
 * Pin mappings aligned to the Nano 33 BLE header.
 */

/ {
    /* Flow sensor interrupt input (D2 / P1.03) */
    water_flow_sensor: flow_sensor {
        compatible = "gpio-keys";
        status = "okay";

        flow_key {
            gpios = <&gpio1 3 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
            label = "Water Flow Sensor";
        };
    };

    /* Rain gauge interrupt input (D3 / P1.10) */
    rain_sensor: rain_sensor {
        compatible = "gpio-keys";
        status = "okay";

        rain_key {
            gpios = <&gpio1 10 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
            label = "Tipping Bucket Rain Sensor";
        };
    };

    /* Debounce and calibration constants shared with the application */
    sensor_config: sensor_config {
        compatible       = "zephyr,sensor-config";
        flow-calibration = <750>;
        debounce-ms      = <2>;
        rain-calibration = <200>;
        rain-debounce-ms = <50>;
    };

    /* Valve drivers mapped to the Nano 33 BLE digital header */
    valves {
        compatible = "gpio-leds";
        status = "okay";

        /* keep a master_valve node for the code; mapped per request */
        master_valve: master_valve { gpios = <&gpio0 6 GPIO_ACTIVE_LOW>; label = "Master Valve"; };

        /* User-requested mapping for the 8 zone valves */
        valve1: valve_1 { gpios = <&gpio0 4 GPIO_ACTIVE_HIGH>; label = "Valve 1"; };
        valve2: valve_2 { gpios = <&gpio0 5 GPIO_ACTIVE_HIGH>; label = "Valve 2"; };
        valve3: valve_3 { gpios = <&gpio0 30 GPIO_ACTIVE_HIGH>; label = "Valve 3"; };
        valve4: valve_4 { gpios = <&gpio0 29 GPIO_ACTIVE_HIGH>; label = "Valve 4"; };
        valve5: valve_5 { gpios = <&gpio0 31 GPIO_ACTIVE_HIGH>; label = "Valve 5"; };
        valve6: valve_6 { gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>; label = "Valve 6"; };
        valve7: valve_7 { gpios = <&gpio0 28 GPIO_ACTIVE_HIGH>; label = "Valve 7"; };
        valve8: valve_8 { gpios = <&gpio0 3 GPIO_ACTIVE_HIGH>; label = "Valve 8"; };
    };

    aliases {
        rtc0               = &rtc_ds3231;
        bme280             = &bme280;
        settings-partition = &settings_partition;
        nvs-storage        = &nvs_storage;
        rain-sensor        = &rain_sensor;
        spi-flash0         = &w25q128;

        console            = &cdc_acm_uart0;
        shell-uart         = &cdc_acm_uart0;
    };

    chosen {
        zephyr,code-partition        = &slot0_partition;
        zephyr,settings-partition    = &settings_partition;
        zephyr,bt-settings-partition = &settings_partition;
        zephyr,console               = &cdc_acm_uart0;
        zephyr,shell-uart            = &cdc_acm_uart0;
    };

    /* Lightweight CPU power states to unlock Zephyr's PM policy */
    power-states {
        runtime_idle: runtime_idle {
            compatible = "zephyr,power-state";
            power-state-name = "runtime-idle";
            exit-latency-us = <50>;
            min-residency-us = <100>;
        };

        suspend_to_idle: suspend_to_idle {
            compatible = "zephyr,power-state";
            power-state-name = "suspend-to-idle";
            exit-latency-us = <300>;
            min-residency-us = <1000>;
        };
    };
};

&i2c0 {
    status = "okay";
    clock-frequency = <I2C_BITRATE_STANDARD>;
    pinctrl-0 = <&i2c0_nano_default>;
    pinctrl-1 = <&i2c0_nano_sleep>;
    pinctrl-names = "default", "sleep";

    rtc_ds3231: ds3231@68 {
        compatible = "maxim,ds3231-mfd";
        reg = <0x68>;
        status = "okay";

        rtc: ds3231_rtc {
            compatible = "maxim,ds3231-rtc";
            status = "okay";
            label = "DS3231";
            isw-gpios = <&gpio0 13 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
        };
    };

    bme280: bme280@77 {
        compatible = "bosch,bme280";
        reg = <0x77>;
        status = "okay";
        label = "BME280";
    };
};

/* SPI2 for W25Q128 external flash */
&spi2 {
    status = "okay";
    compatible = "nordic,nrf-spim";
    pinctrl-0 = <&spi2_default>;
    pinctrl-1 = <&spi2_sleep>;
    pinctrl-names = "default", "sleep";
    cs-gpios = <&gpio0 23 GPIO_ACTIVE_LOW>;

    w25q128: w25q128@0 {
        compatible = "jedec,spi-nor";
        reg = <0>;
        spi-max-frequency = <40000000>;
        jedec-id = [ef 40 18];
        size = <DT_SIZE_M(128)>;  /* 128 Mbit = 16 MB */
        has-dpd;
        t-enter-dpd = <3000>;
        t-exit-dpd = <30000>;

        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            /* Slot 1 for MCUboot secondary image (256 KB) */
            slot1_partition: partition@0 {
                label = "image-1";
                reg = <0x00000000 0x00040000>;
            };

            /* NVS storage partition (256 KB) */
            nvs_storage: partition@40000 {
                label = "nvs_storage";
                reg = <0x00040000 0x00040000>;
            };

            /* Settings partition for BT (8 KB) */
            settings_partition: partition@80000 {
                label = "settings";
                reg = <0x00080000 0x00002000>;
            };

            /* Scratch partition for MCUboot swap (64 KB) */
            scratch_partition: partition@82000 {
                label = "image-scratch";
                reg = <0x00082000 0x00010000>;
            };

            /* Remaining space for future use (approx 15.4 MB) */
            ext_storage_partition: partition@92000 {
                label = "ext_storage";
                reg = <0x00092000 0x00F6E000>;
            };
        };
    };
};

&pinctrl {
    i2c0_nano_default: i2c0_nano_default {
        group1 {
            /* Original working I2C pins for DS3231 and BME280 */
            psels = <NRF_PSEL(TWIM_SCL, 1, 12)>,
                    <NRF_PSEL(TWIM_SDA, 1, 11)>;
            bias-pull-up;
        };
    };

    i2c0_nano_sleep: i2c0_nano_sleep {
        group1 {
            psels = <NRF_PSEL(TWIM_SCL, 1, 12)>,
                    <NRF_PSEL(TWIM_SDA, 1, 11)>;
            bias-pull-up;
            low-power-enable;
        };
    };

    /* SPI2 pinctrl for W25Q128 external flash */
    spi2_default: spi2_default {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 1, 15)>,
                    <NRF_PSEL(SPIM_MOSI, 1, 13)>,
                    <NRF_PSEL(SPIM_MISO, 1, 14)>;
        };
    };

    spi2_sleep: spi2_sleep {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 1, 15)>,
                    <NRF_PSEL(SPIM_MOSI, 1, 13)>,
                    <NRF_PSEL(SPIM_MISO, 1, 14)>;
            low-power-enable;
        };
    };
};

/* Internal flash partitions - MCUboot layout */
/* Delete existing partitions and redefine for MCUboot */
/delete-node/ &code_partition;
/delete-node/ &storage_partition;

&flash0 {
    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>;
        #size-cells = <1>;

        /* Slot 0: Primary application image (MCUboot) */
        slot0_partition: partition@10000 {
            label = "image-0";
            reg = <0x00010000 0x000e8000>;
        };
    };
};

&zephyr_udc0 {
    cdc_acm_uart0: cdc_acm_uart0 {
        compatible = "zephyr,cdc-acm-uart";
        label = "CDC_ACM_0";
    };
};

&{/cpus/cpu@0} {
    cpu-power-states = <&runtime_idle &suspend_to_idle>;
};
