# AutoWatering Capability Compendium (October 2025 build)

This document inventories every capability exposed by the current firmware. It is aimed at integrators who need to understand data paths, feature boundaries, and system behaviour without reading the source directly.

## Core Control Model
- Channel matrix - Eight irrigation channels (`WATERING_CHANNELS_COUNT`) are compiled into `watering_channels[]`. Each channel owns its GPIO descriptor, coverage definition, watering schedule, compensation settings, and persistent runtime state (last watering epoch, days after planting, cached FAO-56 metadata, master-valve mask, and more).
- Mutual exclusion - `MAX_SIMULTANEOUS_VALVES` is fixed at 1 so only one zone valve is energised at any time. The master valve layer (`master_valve_config_t`) wraps every operation with pre-start and post-stop delays (defaults: +3 s / +2 s) and keeps the master open for another 5 s when the next task starts soon enough.
- Task pipeline - All watering work goes through the Zephyr message queue `watering_tasks_queue` (depth 10). The scheduler thread refuses to push additional scheduled jobs when two or more tasks are already waiting, leaving space for manual or remote overrides. `watering_process_next_task()` promotes queued jobs to the execution thread, which tracks the active task in `watering_task_state`.
- Threading and pacing - `watering_start_tasks()` brings up two 2 kB threads: the processing loop (`watering_task_fn`, published as the `watering_task` thread) and the scheduler loop (`scheduler_task_fn`, published as `scheduler_task`). Their sleep intervals remain keyed off `current_power_mode`: 60 s in normal, 120 s in energy-saving, and 300 s in ultra-low-power mode.

## Channel Configuration Catalog
- Identity and hardware - `watering_channel_t` stores the channel name (64 characters), GPIO spec for the zone valve, and runtime state (`is_active`, `last_watering_time`). Master-valve participation is controlled centrally by `master_valve_config_t` (enabled flag, GPIO, pre-start/post-stop delays in seconds, overlap grace window, auto-management switch, active flag).
- Scheduling core - `watering_event_t` defines the base schedule: `schedule_type` (daily mask or periodic interval), `start_time` (hour/minute in local time), `watering_mode` (duration or volume), quantity unions (`duration_minutes` or `volume_liters`), and `auto_enabled` (scheduler toggle). Schedules are stored per channel in NVS and exposed via the BLE Channel Configuration characteristic.
- Coverage and agronomic metadata - Channels reference the compiled databases by index: `plant_db_index` (0..222, `UINT16_MAX` = unset), `soil_db_index` (0..14, `UINT8_MAX` = unset), and `irrigation_method_index` (0..14). Coverage selects between area (`area_m2`) and plant count (`plant_count`). Legacy fields (`plant_type`, `soil_type`, `irrigation_method`, `coverage_legacy`, `plant_info`, `custom_plant`) remain for backward compatibility but new flows rely on the indexed datasets.
- Automatic watering parameters - `auto_mode` selects Quality (100 percent) or Eco (70 percent) FAO-56 outputs. `max_volume_limit_l` caps any single automatic job. `enable_cycle_soak` allows clients to flag soils that need cycle-and-soak strategies. Plant lifecycle tracking uses `planting_date_unix` and `days_after_planting` for FAO-56 crop coefficient staging. `latitude_deg` and `sun_exposure_pct` personalise evapotranspiration calculations.
- Compensation and interval settings - Embedded structs configure rain and temperature compensation (`enabled`, sensitivity/thresholds, lookback hours, reduction factors, base temperatures, min/max factors). Snapshots of the last applied adjustments (`last_rain_compensation`, `last_temp_compensation`) feed BLE status updates. Interval mode stores both the inline structure (minutes/seconds, phase start) and a `interval_config_shadow` copy compatible with API controllers (target totals, cycles completed, current phase, remaining seconds, configured flag).
- Custom soil overlays - `soil_config` toggles between standard database entries and a full custom definition (`name`, field capacity, wilting point, infiltration rate mm/h, bulk density g/cm3, organic matter percent). These numbers override database defaults inside FAO-56 water balance routines.
- Configuration scoring - `config_status` tracks completion flags for basic setup, growing environment, compensation, custom soil, and interval profile. `configuration_score` (0-100) powers onboarding feedback, and `last_reset_timestamp` records when maintenance cleared the configuration group.
- Global toggles - `auto_calc_enabled`, `auto_calc_interval_ms`, `current_power_mode`, `system_initialized`, and `system_status` are system-wide. Automatic calculations are enabled/disabled via BLE Auto-Calc Status characteristic; power mode changes via the System Configuration characteristic or the CLI. Flow calibration defaults to the devicetree value but can be rewritten through the Calibration Management characteristic and is stored under NVS key 1000.
- Database inventories - Compiled resources include 223 plant species (`PLANT_FULL_SPECIES_COUNT`), 15 enhanced soils (`SOIL_ENHANCED_TYPES_COUNT`), and 15 irrigation methods (`IRRIGATION_METHODS_COUNT`). Conversion scripts in `tools/` regenerate these tables from CSV when datasets are updated.

## Sensor Stack and Telemetry
- Inventory - The production hardware assumes three physical sensors: a pulse-based flow meter on the irrigation supply, a tipping-bucket rain gauge, and a BME280 environmental sensor (temperature, humidity, pressure). No soil moisture probes are present in this build; related fields remain reserved for backward compatibility.
- Flow sensor (pulse meter)
  - Hardware interface – The devicetree node `water_flow_sensor` supplies port, pin, and active level; debounce is configurable via the child `sensor_config.debounce_ms` property (default 5 ms).
  - Data products – Atomic pulse count (`get_pulse_count()`), smoothed pulses-per-second rate (two-sample buffer updated every 10 s if at least five pulses arrived), and BLE notifications streamed through the Flow Sensor characteristic once the cumulative pulse count advances by ≥100 or a 30 s guard timer elapses. The ISR only schedules the work item every 25 pulses, so extremely low flow can stretch those notification intervals beyond the 30 s fallback.
  - Configuration knobs – Calibration is persisted under NVS key 1000 and can be set via `set_flow_calibration()` or the Calibration Management characteristic. Accepted range is 100..10 000 pulses per litre (default pulled from devicetree, fallback 450). Debug output (`flow_sensor_debug_info()`) reports the smoothing buffer, calibration, and last notification counter.
  - Safety & diagnostics – `check_flow_anomalies()` inspects counts roughly once per second. It raises `WATERING_STATUS_NO_FLOW` after three consecutive 3 s stalls with an open valve, and `WATERING_STATUS_UNEXPECTED_FLOW` when ≥10 pulses arrive while every valve is closed. BLE alarm/status characteristics mirror these fault codes.

- Rain sensor (tipping bucket)
  - Hardware interface – `rain_sensor_config_t.debounce_ms` (default 5 ms) debounces GPIO interrupts. Configuration is stored in `rain_nvs_config_t`: calibration (`mm_per_pulse`, default 0.2 mm), debounce, `sensor_enabled`, `integration_enabled`, `rain_sensitivity_pct`, `skip_threshold_mm`, and `last_reset_time`.
  - Data products – Hourly and daily accumulators capture rainfall in 0.01 mm increments alongside pulse counts and data-quality scores. BLE characteristics `19-rain-sensor-data`, `18-rain-sensor-config`, and `20-rain-history-control` expose live readings, configuration, and streaming controls. Persistent counters (`rain_nvs_state_t`) remember total pulses, last pulse time, current hour/day totals.
  - Health & diagnostics – The driver tracks pulse statistics (mean and standard deviation of interval timing), outlier suppression, accuracy percentage, and consecutive error counts. A watchdog (`check_rain_sensor_health()`) runs every 5 minutes to reinitialise the sensor, rain history, and rain integration modules on failure, and to validate NVS payloads.
  - Integration controls – Rain integration settings (`rain_integration_config_t`) include `rain_sensitivity_pct`, `skip_threshold_mm`, `effective_rain_factor`, `lookback_hours`, and `integration_enabled`. APIs and BLE status characteristics surface current values, reduction percentages, skip flags, and confidence levels.

- Environmental suite (BME280)
  - Hardware interface – `sensor_manager_init_bme280()` initialises the BME280 on the primary I2C bus if present. Simulation paths behind `CONFIG_ENV_SENSORS_SIM` generate deterministic data for tests.
  - Data products – `environmental_data_t` tracks mean/min/max temperature, humidity, pressure, rainfall over the last 24 h, derived dewpoint and vapour pressures, measurement interval, timestamp, validity flags, and a 0-100 data quality score.
  - Configuration knobs – `env_sensor_config_t` toggles sensor enable flags, measurement intervals (`temp_interval_min`, `humidity_interval_min`, `rain_interval_min`), calibration offsets (`temp_offset_c`, `humidity_offset_pct`, `rain_calibration_factor`), and quality thresholds (`min_data_quality`, `max_sensor_age_min`). Default values (production build) enable all sensors, poll temperature/humidity every 15 minutes and rain every 60 minutes, apply zero offsets, and require ≥80 data quality with data fresher than 120 minutes.
  - Health & diagnostics – `env_sensor_status_t` records sensor online flags, last successful timestamps, per-sensor error counts, and an overall health score. BLE characteristics (`21-environmental-data`, `22-environmental-history`) and console logging expose these metrics. Low-power mode inflates measurement intervals to reduce I2C activity.

- Derived telemetry and compensation
  - Rain integration – Combines recent rainfall (up to `lookback_hours`), soil infiltration (`effective_rain_factor`), and channel sensitivity to produce `rain_irrigation_impact_t` (recent rainfall, effective rainfall, reduction percentage, skip boolean, confidence score). The Module caches the last result per channel and emits diagnostics (success/failure counts, calculation success rate).
  - Rain compensation engine – `rain_compensation_config_t` adds higher-level policies (algorithm selection via `rain_compensation_set_algorithm()`, reduction factors, skip thresholds, lookback hours). Each calculation fills `rain_compensation_calculation_t` (effective rainfall, adjusted requirement, reduction percent, skip, confidence, status).
  - Temperature compensation – Channel-local configuration (`temperature_compensation_config_t`) defines base temperature, sensitivity, and min/max factors. Runtime helpers (`temp_compensation_calculate()`, `temp_comp_apply_to_fao56()`) adjust FAO-56 outputs or interval calculations. Results are stored in `last_temp_compensation` for BLE telemetry.
  - Enhanced system status – `enhanced_system_status_info_t` aggregates active interval phases, compensation state, sensor health, configuration completeness, channel bitmaps, and timestamps. BLE diagnostics use this struct to present consolidated system health.

## Watering Modes and Execution Lifecycle
- By duration (`WATERING_BY_DURATION`)
  - The channel valve is held open for the configured number of minutes. Interval mode can split the runtime into alternating watering/pause phases when `interval_config.configured` is true.
  - Completion is determined by elapsed time minus any paused intervals. Flow monitoring remains active solely for anomaly detection.

- By volume (`WATERING_BY_VOLUME`)
  - The firmware targets a specific number of litres. Before opening the valve it resets the flow pulse counter. Completion occurs when `pulses * 1000 / calibration` meets the litre target. A minimum of 1 litre is enforced.
  - Interval mode is supported and adjusts litres delivered per phase accordingly.

- Automatic Quality (`WATERING_AUTOMATIC_QUALITY`)
  - Channels marked for Quality mode are eligible for automatic FAO-56 calculations. `watering_run_automatic_calculations()` snapshots the existing event, converts the computed requirement into a one-off volume job (100 percent of the FAO-56 result, minimum 1 litre), and queues it.

- Automatic Eco (`WATERING_AUTOMATIC_ECO`)
  - Same process as Quality mode, but the generated task delivers 70 percent of the FAO-56 requirement (30 percent reduction).

- Interval mode integration
  - `interval_task_should_use_interval()` validates the interval profile and ensures the watering mode is duration or volume based.
  - `interval_controller_t` orchestrates watering/pause phases, counts cycles, calculates remaining phase time, and surfaces progress through the enhanced BLE task characteristic. Manual pause/resume/stop commands interact with the controller and keep the master valve in sync.

- Rain-aware execution
  - Before a task starts, `rain_integration_calculate_impact()` recomputes the skip flag and percentage reduction using the latest rainfall data. Skipped tasks restore their snapshots and log a rain-skip history entry. Partial reductions adjust duration or volume but never below 1 minute or 1 litre.

- Task completion
  - On completion (success or error), the system logs actual duration/volume, raises BLE notifications, restores the original event configuration, and frees the queue slot. Master-valve logic either closes immediately or after the configured delay, depending on whether another task is pending within the overlap window.

## Scheduling and Time Base
- RTC anchoring - Each scheduler pass obtains wall-clock time from the RTC and converts it to local time via `timezone` helpers. If the RTC fails five times in a row, the system temporarily falls back to uptime estimates until the RTC recovers.
- Day tracking - When the day component changes, `days_since_start` increments, configuration is saved to NVS, and periodic schedules test whether the modulo condition is met.
- Queue policies - Scheduled jobs are enqueued only when the current local hour/minute matches `event.start_time` and the day mask or periodic interval condition is satisfied. Manual jobs bypass the scheduler and go straight into the queue if space allows.
- Power-aware sleeping - After every scheduling pass the thread sleeps for 60/120/300 s depending on the active power mode, trading responsiveness for power savings when required.

## Automatic Irrigation Calculation Pipeline
1. Trigger cadence - The scheduler verifies that `auto_calc_enabled` is true and at least `auto_calc_interval_ms` (default 1 hour, configurable 1-24 hours) have elapsed since the last run.
2. Eligibility - Channels in Quality or Eco mode, and without an active task, are candidates for automatic processing.
3. Environmental inputs - `env_sensors_read()` supplies the latest measurements. If a parameter is invalid, the pipeline substitutes safe defaults (for example 20 degC and 60 percent RH) or aborts the channel when no reliable data are available.
4. FAO-56 computation - `fao56_calculate_irrigation_requirement()` performs a sequential set of steps:
   - Reference evapotranspiration (ET0) – Retrieve cached ET0 when the same inputs were processed recently, otherwise compute Penman-Monteith using temperature, humidity, pressure, latitude, and day-of-year. If humidity or pressure are missing, the routine falls back to Hargreaves-Samani (temperature-only) but marks the result as a fallback.
   - Crop coefficient – Combine plant database entries (stage lengths, Kc values) with `days_after_planting`. Values are cached per channel to avoid recomputation inside the same session. Legacy plant-type data is used only when database indices are unset.
   - Soil water balance – If plant/soil/method indices are valid, `calc_water_balance()` computes readily available water (RAW), total available water (TAW), current deficit, and net irrigation requirement using custom soil overrides where present. If any dataset is missing the algorithm degrades to a simplified deficit model driven by ETc minus effective rainfall.
   - Effective rainfall – Hourly/daily rain history plus `rain_integration_calculate_effective_rainfall()` determine how much rainfall offsets the deficit. The effective rain factor (default 0.8) and rain integration toggle influence this step even when automatic compensation is disabled.
   - Volume conversion – Convert mm of irrigation into litres using either area coverage (`area_m2`) or implicit per-plant area (default 0.5 m2). Apply Eco reductions (70 percent) and enforce `max_volume_limit_l`. Cycle-and-soak flag is tracked for use in scheduling strategies.
   - Record `last_calculation_time` and update channel water balance caches for diagnostics.
5. Task materialisation - The controller snapshots the existing event, converts the FAO-56 recommendation into a temporary `WATERING_BY_VOLUME` task (minimum 1 litre), and enqueues it. If the queue is full the snapshot is restored and an error is logged.
6. Optional adjustments - Rain and temperature compensation helpers (`rain_compensation_*`, `temp_comp_apply_to_*`) are available for clients who want to tweak the computed job further.
7. Notifications - When at least one channel schedules successfully, `bt_irrigation_auto_calc_status_notify()` informs connected BLE clients so interfaces can refresh proactively.

## Data Persistence and Storage Layout
- NVS footprint - Channel configuration, custom soil overlays, onboarding flags, schedule flags, system flags (flow calibration, master valve, RTC, rain sensor, power mode, location, initial setup), automatic calculation state, timezone config, flow calibration, and days since start are all saved via the `nvs_config` helpers. Each helper validates payload size before committing.
- Watering history - Detailed events (30 per channel) store: timing delta (`dt_delta`), trigger type, success/error flags, target ml or minutes, actual ml, average flow rate, and reserved bytes. Daily stats (90 entries) track day epoch, total ml, sessions ok/error counts, success rate, and busiest channel. Monthly stats (36 compressed entries) include year, month, total ml, active days, peak channel. Annual stats (10 entries) summarise year, total ml, total sessions, errors, max month, and average efficiency. Insights cache and rotation metadata persist alongside the ring buffers.
- Rain history - Hourly records (720) store hour epoch, rainfall in 0.01 mm units, raw pulse count, and data quality (0-100). Daily records (1 825) capture day epoch, total rainfall, peak hourly rainfall, hours with activity, and completeness percentage. NVS rows also retain total pulses and last pulse timestamps so counters survive resets. Cleanup triggers above 80 percent utilisation and trims oldest entries before persisting.
- Environmental history - Hourly entries contain timestamp, BME280 reading snapshot, rainfall mm, watering events count, total volume ml, and an active-channel bitmap. Daily entries record min/max/avg temperature, humidity, pressure, total rainfall, watering events, total volume, sample count, and active-channel bitmap. Monthly entries capture YYYYMM, aggregated temperature/humidity/pressure stats, total rainfall, total watering events, total volume, and active days. These datasets back the Environmental History BLE requests.
- Storage health - `nvs_storage_monitor` mounts the partition, calculates used/free bytes, counts read and write errors, and schedules clean-up runs that return usage to around 70 percent once the 80 or 90 percent thresholds are crossed. A BLE characteristic exposes the current health message and utilisation percentage.
- Onboarding/reset logs - `onboarding_state` stores channel config flags (plant, soil, irrigation method, coverage, sun exposure, name, water factor, enabled), schedule bitmask, system flags, onboarding start and update timestamps, and calculated completion percentage. `config_reset_log_t` (16-entry rings per channel) records reset group, timestamp, channel, and reason string. Reset controller confirmation codes capture requested scope, channel ID, code, generation time, and expiry.

## Bluetooth Low Energy Surfaces
- Notification scheduler - A pool of eight 23-byte buffers drives asynchronous notifications. Priority throttles (critical 0 ms, high 50 ms, normal 200 ms, low 1 s) prevent congestion. Failed transmissions retry three times; buffer exhaustion waits 2 s before attempting again.
- Valve control - Writes to the valve characteristic queue tasks for channels 0-7. Channel 0xFF toggles the master valve directly when automatic management is disabled. Notifications confirm physical valve transitions, and safety checks reject invalid `task_type` values.
- Status suites - System status, queue depth, active task snapshot, last completed task, flow metrics, rain integration status, compensation summaries, environmental snapshots, storage health, and onboarding progress are all surfaced via dedicated GATT characteristics in `bt_irrigation_service`.
- History streaming - Watering, environmental, and rain records stream through TLV-framed characteristics with fragment sequencing and client acknowledgements. Rain history caps each transfer at 20 fragments to respect BLE buffer limits.
- Configuration portals - BLE handlers accept writes for channel metadata, schedules, interval profiles, custom soil data, compensation flags, onboarding flags, reset codes, and automatic calculation settings. Key characteristics include 04-channel-configuration (channel struct), 05-schedule-configuration (event timing), 06-system-configuration (power mode, master valve, flow calibration flag), 11-calibration-management (flow calibration updates), 15-auto-calc-status (auto enable/interval), 18-rain-sensor-config (rain calibration and thresholds), and 26-reset-control (confirmation code workflow). Every handler validates arguments before updating RAM or NVS.

## Onboarding, Scoring, and Reset
- Onboarding ledger - Channel-level flags (plant, soil, irrigation method, coverage, sun exposure, name, water factor, enabled), schedule flags, and system flags live in `onboarding_state`. Completion percentage is recomputed after every update. Onboarding is considered complete when at least one channel sets all critical flags and the RTC flag is raised.
- Configuration scoring - `configuration_status` weights configuration groups (basic setup 25 percent, growing environment 25 percent, compensation 20 percent, custom soil 15 percent, interval profile 15 percent). It also keeps per-channel reset logs (ring buffer of 16 entries) with timestamps and reasons, stored in NVS.
- Reset mechanics - Reset commands require a 32-bit confirmation code generated by the controller and valid for 5 minutes (`RESET_CONFIRMATION_VALIDITY_SEC`). Supported scopes include single-channel configuration, all channels, schedule-only reset, system configuration, calibration, histories, and full factory reset. Channel-specific resets embed the target channel ID in the confirmation context.

## System Status, Recovery, and Diagnostics
- Status taxonomy - Base status values include `OK`, `FAULT`, `NO_FLOW`, `UNEXPECTED_FLOW`, `RTC_ERROR`, and `LOW_POWER`. The enhanced status module derives interval phase, compensation flags, sensor health indicators, configuration completeness, and bitmaps of active, interval, and incomplete channels.
- Recovery strategies - `enhanced_error_handling` maps enhanced error codes to strategies (retry, fallback, disable, reset, graceful degrade) with configurable retry ceilings and cool-down timers. Dedicated recovery contexts exist for BME280 initialisation, sensor read failures, compensation errors, interval controller failures, storage issues, and sensor degradation detection.
- Diagnostics availability - Flow, rain, environmental, storage, and task subsystems expose detailed diagnostic strings and statistics on demand. BLE mirrors many of these diagnostics so field tools can pull them without serial access.
- Maintenance hooks - Daily, weekly, and monthly routines keep histories compact, validate stored data, and write fresh snapshots to NVS. Rain sensor and integration watchdogs attempt recovery automatically, and storage monitors trigger clean-ups when utilisation crosses thresholds.

## Limitations and Behaviour Notes
- Compensation engines - Rain and temperature compensation APIs are available for integrators to adjust FAO-56 suggestions. Integrators who need those adjustments should call the relevant helpers after retrieving the FAO-56 suggestion.
- Interval mode job creation - Interval profiles only control execution cadence; they do not schedule jobs on their own. Users must still create duration or volume tasks.
- Master valve manual mode - When automatic master valve management is disabled, clients must open and close the master valve explicitly. Manual toggles are rejected while auto-management is enabled.
- Watering history rotation - Automatic removal of very old watering history entries is scaffolded. Extremely full NVS partitions might require manual clean-up.

This document reflects the behaviour of the firmware located in `c:\Users\tapir\Documents\Zephyr\AutoWatering`. Update it alongside code changes to keep integration and support teams aligned with the shipped feature set.
