#############################################
# MCUboot Bootloader Configuration
# USB Serial Recovery + External Flash Support
#############################################

# ---------- Serial Recovery (USB CDC ACM) ----------
# Enable MCUboot's serial recovery mode for USB DFU
CONFIG_MCUBOOT_SERIAL=y
CONFIG_BOOT_SERIAL_CDC_ACM=y

# ---------- Recovery Mode Entry ----------
# Wait briefly for DFU connection at boot (allows recovery even if app crashes)
CONFIG_BOOT_SERIAL_WAIT_FOR_DFU=y
CONFIG_BOOT_SERIAL_WAIT_FOR_DFU_TIMEOUT=3000

# Alternative: Use dedicated button (mcuboot_button0 alias)
# Uncomment if hardware button is wired for recovery
# CONFIG_BOOT_SERIAL_ENTRANCE_GPIO=y

# ---------- Image Management ----------
# Enable swap using scratch partition (required for safe rollback)
CONFIG_BOOT_SWAP_USING_SCRATCH=y

# ---------- External Flash Support ----------
# SPI NOR flash driver for W25Q128
CONFIG_SPI=y
CONFIG_SPI_NOR=y
CONFIG_SPI_NOR_SFDP_RUNTIME=y
CONFIG_SPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096

# Flash operations
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y
CONFIG_FLASH_PAGE_LAYOUT=y

# ---------- Logging (minimal for bootloader) ----------
CONFIG_LOG=y
CONFIG_LOG_MODE_MINIMAL=y
CONFIG_LOG_DEFAULT_LEVEL=0
CONFIG_BOOT_BANNER=y
CONFIG_PRINTK=y

# ---------- Console Disabled ----------
# UART console conflicts with CDC ACM - disable it
CONFIG_CONSOLE=n
CONFIG_UART_CONSOLE=n

# ---------- USB Stack for Recovery ----------
# NOTE: MCUboot serial recovery (CONFIG_BOOT_SERIAL_CDC_ACM) uses the legacy USB device stack.
# Keep NEXT disabled to avoid duplicate USB IRQ registrations.
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_CDC_ACM=y
CONFIG_USB_DEVICE_STACK_NEXT=n
CONFIG_USBD_CDC_ACM_CLASS=n
CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y
CONFIG_USB_DEVICE_VID=0x2FE3
CONFIG_USB_DEVICE_PID=0x0100

# ---------- Multithreading ----------
CONFIG_MULTITHREADING=y

# ---------- Crypto ----------
# Development setup: accept unsigned images (keeps bootloader smaller and avoids crypto warnings).
CONFIG_BOOT_SIGNATURE_TYPE_NONE=y
